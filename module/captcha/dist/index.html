<div><div class="ldcv" ld="cover"><div class="base"><div class="inner p-4" ld="inner"><div class="d-flex align-items-center justify-content-center h-100"><div class="text-center"><div class="mb-4" ld="box"></div><div class="btn btn-outline-secondary btn-block" data-ldcv-set="ok">OK</div></div></div></div></div></div><script type="@plotdb/block">var provider, ref$, captcha;
provider = function(o){
  o == null && (o = {});
  return import$(this, o);
};
provider.prototype = (ref$ = Object.create(Object.prototype), ref$.create = function(o){
  o == null && (o = {});
  return new this.factory(o);
}, ref$.cfg = function(o){
  if (o != null) {
    return import$(this._cfg || (this._cfg = {}), o);
  } else {
    return this._cfg || {};
  }
}, ref$);
captcha = {
  _p: {},
  _order: null,
  cfg: {},
  init: function(cfg){
    var k, ref$, v, results$ = [];
    cfg == null && (cfg = {});
    this.cfg = cfg;
    for (k in ref$ = this._p) {
      v = ref$[k];
      results$.push(v.cfg(import$({}, this.cfg[k])));
    }
    return results$;
  },
  register: function(n, o){
    var p, itf, f, ref$;
    o == null && (o = {});
    this._p[n] = p = new provider(o);
    itf = p['interface'] || {};
    p.factory = f = function(o){
      o == null && (o = {});
      this.opt = o;
      this.init();
      return this;
    };
    return f.prototype = (ref$ = import$(import$({
      _provider: p
    }, Object.create(Object.prototype)), itf), ref$.priority = 99, ref$._init = itf.init, ref$.init = function(){
      var this$ = this;
      return this._provider.init().then(function(){
        return this$._init();
      });
    }, ref$);
  },
  get: function(n){
    return this._p[n];
  },
  order: function(ns){
    var list, res$, k, ref$, v, this$ = this;
    ns == null && (ns = []);
    res$ = [];
    for (k in ref$ = this._p) {
      v = ref$[k];
      res$.push([k, v]);
    }
    list = res$;
    list.sort(function(a, b){
      return (a[1].priority || 99) - (b[1].priority || 99);
    });
    list = list.map(function(it){
      return it[0];
    });
    this._order = ns.filter(function(it){
      return in$(it, list);
    }).concat(list.filter(function(it){
      return !in$(it, ns);
    }));
    return this._order = this._order.filter(function(it){
      return this$.cfg[it] && this$.cfg[it].enabled && this$.cfg[it].sitekey;
    });
  },
  guard: function(opt){
    var _, this$ = this;
    opt == null && (opt = {});
    if (!this._order) {
      this.order();
    }
    if (!this._order.length) {
      return Promise.resolve().then(function(){
        return opt.cb();
      });
    }
    _ = function(idx){
      idx == null && (idx = 0);
      if (idx >= this$._order.length) {
        return lderror.reject(1010);
      }
      return this$.blah(import$({
        name: this$._order[idx]
      }, opt)).then(function(ret){
        return opt.cb(ret);
      })['catch'](function(){
        return debounce(1000).then(function(){
          return _(idx + 1);
        });
      });
    };
    return _();
  },
  verify: function(opt){
    opt == null && (opt = {});
    if (!this.cfg[opt.name]) {
      lderror.reject(1010);
    }
    return this._p[opt.name].verify(import$(import$({}, this.cfg[opt.name]), opt));
  },
  prepare: function(it){
    return this.root = it;
  },
  blah: function(arg$){
    var name, node, ldcv, p, this$ = this;
    name = arg$.name;
    if (!(this.obj || (this.obj = {}))[name]) {
      node = this.root.querySelector('.ldcv').cloneNode(true);
      this.root.appendChild(node);
      ldcv = new ldcover({
        root: node
      });
      p = ldcv.get();
      this.obj[name] = {
        obj: this.get(name).create({
          root: node.querySelector('[ld=box]')
        }),
        ldcv: ldcv
      };
    } else {
      p = this.obj[name].ldcv.get();
    }
    return this.obj[name].obj.init().then(function(){
      return this$.obj[name].obj.render();
    }).then(function(){
      return p;
    }).then(function(){
      return this$.obj[name].obj.get();
    })['catch'](function(){
      return {};
    });
  },
  examine: function(){
    var root, v, inner, capobj, this$ = this;
    root = this.root;
    v = new ldview({
      root: root,
      action: {
        click: {
          ok: function(){
            return capobj.get().then(function(it){
              console.log('result', it);
              return this$.ldcv.toggle(false);
            });
          }
        }
      }
    });
    inner = root.querySelector('[ld=box]');
    this.ldcv = new ldcover({
      root: root.querySelector('.ldcv')
    });
    this.ldcv.toggle();
    capobj = captcha.get('recaptcha_v2_checkbox').create({
      root: inner
    });
    capobj = capobj;
    return capobj.init().then(function(){
      capobj.render();
      return console.log("capobj inited");
    });
  }
};
captcha.register('hcaptcha', {
  priority: 3,
  init: proxise.once(function(){
    var this$ = this;
    return new Promise(function(res, rej){
      var s;
      this$._script = s = document.createElement('script');
      s.onerror = function(it){
        return rej(it);
      };
      s.onload = function(){
        this$.inited = true;
        return res();
      };
      s.setAttribute('type', 'text/javascript');
      s.setAttribute('src', "https://js.hcaptcha.com/1/api.js");
      return document.body.appendChild(s);
    });
  }),
  'interface': {
    init: function(){
      this.root = typeof this.opt.root === 'string'
        ? document.querySelector(this.opt.root)
        : this.opt.root;
      this._tag = document.createElement('div');
      return this.root.appendChild(this._tag);
    },
    reset: function(){
      return hcaptcha.reset(this.id);
    },
    render: function(){
      var ref$;
      if (!this.id) {
        return this.id = hcaptcha.render(this._tag, {
          theme: (ref$ = this._provider.cfg()).theme,
          size: ref$.size,
          sitekey: ref$.sitekey
        });
      } else {
        return this.reset();
      }
    },
    get: function(){
      var p, ret;
      p = (ret = hcaptcha.getResponse(this.id))
        ? Promise.resolve(ret)
        : (this.render(), hcaptcha.execute(this.id, {
          async: true
        }).then(function(arg$){
          var response, key;
          response = arg$.response, key = arg$.key;
          return response;
        }));
      return p.then(function(it){
        return {
          token: it,
          name: 'hcaptcha'
        };
      });
    }
  }
  /*
  verify: (opt={}) ->
    @init opt
      .then ~>
        if !(@sitekey and @enabled) => return lderror.reject 998
        if !@ldcv =>
          node = ld$.find('#captcha', 0).cloneNode true
          @ldcv = new ldcover root: node
          @_tag = document.createElement \div
          node.appendChild @_tag
          @id = hcaptcha.render @_tag, @_cfg{theme, size, sitekey}
        else hcaptcha.reset @id
        ret = @ldcv.get!
        hcaptcha.execute @id, async: true
          .then ({response, key}) ~> @ldcv.set {token: response, name: \hcaptcha}
        ret
  */
});
captcha.register('recaptcha_v3', {
  priority: 1,
  init: proxise.once(function(){
    var this$ = this;
    return Promise.resolve().then(function(){
      return new Promise(function(res, rej){
        var s;
        this$._script = s = document.createElement("script");
        s.onerror = function(it){
          return rej(it);
        };
        s.onload = function(){
          return grecaptcha.ready(function(){
            return res(this$.inited = true);
          });
        };
        s.setAttribute('type', 'text/javascript');
        s.setAttribute('src', "https://www.google.com/recaptcha/api.js?render=" + this$._cfg.sitekey);
        return document.body.appendChild(s);
      });
    });
  }),
  'interface': {
    init: function(){},
    get: function(){
      var cfg;
      cfg = this._provider.cfg();
      if (!(cfg.sitekey && cfg.enabled)) {
        return lderror.reject(998);
      }
      return grecaptcha.execute(cfg.sitekey, {
        action: 'generic'
      });
    },
    reset: function(){},
    render: function(){}
  }
  /*
  verify: (opt={}) ->
    @init opt
      .then ~>
        if !(@sitekey and @enabled) => return lderror.reject 998
        grecaptcha.execute @sitekey, {action: opt.action or 'generic'}
      .then (token) -> return {token, name: \recaptcha_v3}
  */
});
captcha.register('recaptcha_v2_checkbox', {
  priority: 2,
  init: proxise.once(function(){
    var this$ = this;
    return new Promise(function(res, rej){
      var s;
      this$._script = s = document.createElement("script");
      s.onerror = function(it){
        return rej(it);
      };
      s.onload = function(){
        return grecaptcha.ready(function(){
          return res(this$.inited = true);
        });
      };
      s.setAttribute('type', 'text/javascript');
      s.setAttribute('src', 'https://www.google.com/recaptcha/api.js');
      document.body.appendChild(s);
      return this$.ldcv = new ldcover({
        root: ld$.find('#captcha', 0)
      });
    });
  }),
  'interface': {
    init: function(){
      this.root = typeof this.opt.root === 'string'
        ? document.querySelector(this.opt.root)
        : this.opt.root;
      this._tag = document.createElement('div');
      return this.root.appendChild(this._tag);
    },
    get: function(){
      var this$ = this;
      return Promise.resolve().then(function(){
        var ret;
        ret = grecaptcha.getResponse(this$.id);
        return {
          token: ret,
          name: 'hcaptcha'
        };
      });
    },
    reset: function(){},
    render: function(){
      var ref$;
      return this.id = grecaptcha.render(this._tag, {
        theme: (ref$ = this._provider.cfg()).theme,
        size: ref$.size,
        sitekey: ref$.sitekey
      });
    }
  }
  /*
  verify: (opt={}) ->
    @init opt
      .then ~>
        if !(@sitekey and @enabled) => return lderror.reject 998
        @_tag = document.createElement \div
        ld$.find('#captcha-inner', 0).innerHTML = ''
        ld$.find('#captcha-inner', 0).appendChild @_tag
        ret = @ldcv.get!
        @id = grecaptcha.render @_tag, @{theme, size, sitekey}
        ret
      .then -> token: grecaptcha.getResponse(@id), name: \recaptcha_v2_checkbox
      .catch -> return Promise.reject it
  */
});
if (typeof module != 'undefined' && module !== null) {
  module.exports = {
    init: function(arg$){
      var root;
      root = arg$.root;
      return captcha.prepare(root);
    },
    'interface': function(){
      return captcha;
    }
  };
} else if (window) {
  window.captcha = captcha;
}
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}
function in$(x, xs){
  var i = -1, l = xs.length >>> 0;
  while (++i < l) if (x === xs[i]) return true;
  return false;
}</script></div>
