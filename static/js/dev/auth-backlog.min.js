function import$(n,e){var t={}.hasOwnProperty;for(var r in e)t.call(e,r)&&(n[r]=e[r]);return n}function in$(n,e){for(var t=-1,r=e.length>>>0;++t<r;)if(n===e[t])return!0;return!1}var slice$=[].slice;ldc.register("auth",["ldsite","ldcvmgr","loader","util","error"],function(n){var e,t,r,o,i,u,c,a,l,s,f,d,h,g,p;return e=n.ldsite,t=n.ldcvmgr,r=n.loader,o=n.util,i=n.error,u=function(){return a.global?JSON.parse(JSON.stringify(a.global)):null},c=[{},{}],a=c[0],l=c[1],s={lc:{ready:!1,queue:[],tag:null,sitekey:null,global:null,enabled:!0,inited:!1},init:function(){var n=this;return this.lc.inited?Promise.resolve():g.get().then(function(e){var t;return t=n.lc,t.global=e,t.sitekey=(e.recaptcha||(e.recaptcha={})).sitekey,t.enabled=(e.recaptcha||(e.recaptcha={})).enabled,t}).then(function(){var e;if(n.lc.enabled&&n.lc.sitekey&&!n.lc.tag)return n.lc.tag=e=document.createElement("script"),e.onload=function(){return grecaptcha.ready(function(){return n.lc.ready=!0,n.lc.queue.map(function(n){return n.res()}),n.lc.queue.splice(0)})},e.setAttribute("type","text/javascript"),e.setAttribute("src","https://www.google.com/recaptcha/api.js?render="+n.lc.sitekey),document.body.appendChild(e)}).then(function(){return n.lc.inited=!0})},get:function(n){var e=this;return null==n&&(n="generic"),this.init().then(function(){return e.lc.sitekey&&e.lc.enabled?(e.lc.ready?Promise.resolve():new Promise(function(n,t){return e.lc.queue.push({res:n,rej:t})})).then(function(){return grecaptcha.execute(e.lc.sitekey,{action:n})}).then(function(n){return n}):Promise.resolve("")})}},(f={dom:ld$.find(document,"[ld-scope=cookie-consent]",0),val:o.cookie("consent.cookie"),clear:function(){if(this.dom)return ld$.remove(this.dom),this.dom=null},check:function(){var n=this;return g.get().then(function(e){var t,r;return t=e.user,((r=t.config||(t.config={})).consent||(r.consent={})).cookie&&n.dom?n.clear():(n.val=o.cookie("consent.cookie"))&&!((r=t.config||(t.config={})).consent||(r.consent={})).cookie&&t.key?ld$.fetch(g.api+"/me/config",{method:"POST"},{json:{type:"consent",name:["cookie"]}}).then(function(n){var e;return null==n&&(n={}),import$(t.config||(t.config={}),n),o.cookie("consent.cookie",((e=n.config||(n.config={})).consent||(e.consent={})).cookie||Date.now(),new Date(Date.now()+31536e8).toGMTString())}).catch(function(){}):void 0})},init:function(){var n=this;if(!this.val&&this.dom)return this.dom.classList.remove("d-none"),ld$.find(this.dom,"[ld=ok]",0).addEventListener("click",function(){return n.clear(),n.check()})}}).init(),d=function(n){var e,t,r,o,i;if(e=a.authpanel=(t=n)?t:ld$.find(document,".authpanel",0),a.authpanel&&!a.inited)return a.inited=!0,ld$.find(e,"[data-action]"),e.addEventListener("click",function(n){var e;if(n&&n.target&&n.target.getAttribute)return e=n.target.getAttribute("data-action"),g.switch(e)}),a.form=r=new ldForm({names:function(){return["email","passwd","displayname"]},afterCheck:function(n,e){return 1===n.email||/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.[a-z]{2,}|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i.exec(e.email.value)||(n.email=2),1!==n.passwd&&(n.passwd=e.passwd.value?(e.passwd.value+"").length<8?2:0:1),"login"===g.act?n.displayname=0:n.displayname=e.displayname.value?e.displayname.value?0:2:1},root:e}),l.submit=ld$.find(e,"[data-action=submit]",0),o=new ldLoader({root:l.submit}),r.on("readystatechange",function(n){return l.submit.classList.toggle("disabled",!n)}),r.field("passwd").addEventListener("keyup",function(n){if(13===n.keyCode)return r.check({now:!0}).then(function(){return i()})}),l.submit.addEventListener("click",function(){return i()}),i=function(){var n,e,t,i;if(r.ready())return o.on(),n=r.values(),i={},i.email=n.email,i.passwd=n.passwd,i.displayname=n.displayname,t=i,t.config={newsletter:n.newsletter},e=t,e.passwd=e.passwd.replace(/\t*$/,""),s.get("signin").then(function(n){return e.recaptcha=n}).then(function(){return g.consent({timing:"signin"})}).then(function(){return ld$.fetch("login"===g.act?g.api+"/u/login":g.api+"/u/signup",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json; charset=UTF-8"}},{type:"text"})}).then(function(){return g.fetch()}).then(function(){return g.get()}).then(function(n){return p.info("default"),n.user&&lda.auth.hide("ok"),r.reset(),o.off()}).then(function(){return g.consent({timing:"signin",bypass:!0})}).then(function(){return g.fire("auth.signin")}).catch(function(){return g.act&&"signup"!==g.act?p.info("failed"):p.info("signup-failed"),r.fields.passwd.value=null,r.check({n:"passwd",now:!0}),o.off()})}},h=proxise(function(){if(a.global)return Promise.resolve(a.global)}),(g={api:(e?e.api:"d").replace(/\/$/,""),init:function(n){var e;if(null==n&&(n={}),n.root)return e="string"==typeof n.root?document.querySelector(n.root):n.root,d(e)},evtHandler:{},on:function(n,e){var t;return((t=this.evtHandler)[n]||(t[n]=[])).push(e)},fire:function(n){var e,t,r,o,i,u=[];for(e=slice$.call(arguments,1),t=0,o=(r=this.evtHandler[n]||[]).length;t<o;++t)i=r[t],u.push(i.apply(this,e));return u},manuallyInit:function(n){var e;if(null==n&&(n={}),n.root)return e="string"==typeof n.root?document.querySelector(n.root):n.root,d(e)},switch:function(n){var e=this;if("signup"===n||"login"===n)return(a.authpanel?Promise.resolve(a.authpanel):t.getdom("authpanel")).then(function(t){var r,o;return d(t),r=t.classList.contains("authpanel")?t:ld$.find(t,".authpanel",0),(o=r.classList).remove("signup","login"),o.add(e.act=n),a.form.check({now:!0})})},social:function(n){var e,r=this;return e=null,g.consent({timing:"signin"}).then(function(){return r.get()}).then(function(t){var r,o;return r=t.csrfToken,window.open("","social-login","height=640,width=560"),e=ld$.create({name:"div"}),e.innerHTML='<form target="social-login" action="'+g.api+"/u/auth/"+n+'/" method="post">\n  <input type="hidden" name="_csrf" value="'+r+'"/>\n</form>',document.body.appendChild(e),window.socialLogin=o=proxise(function(){return ld$.find(e,"form",0).submit()}),o()}).then(function(){return r.fetch()}).then(function(n){var e;if(!(e=n.user)||!e.key)return Promise.reject(new ldError(1e3))}).then(function(){return t.isOn("authpanel")?lda.auth.hide("ok"):window.location.reload()}).then(function(){return g.consent({timing:"signin",bypass:!0})}).then(function(){return g.fire("auth.signin")}).finally(function(){if(e)return ld$.remove(e)}).catch(i({ignore:[999,1e3]}))},fb:function(){return this.social("facebook")},google:function(){return this.social("google")},logout:function(){return r.on(),ld$.fetch(g.api+"/u/logout",{method:"post"},{}).then(function(){return g.fetch({renew:!0})}).then(function(){return t.toggle("logout")}).then(function(){return r.off()}).catch(function(){return t.toggle("error")})},ensure:function(n){return null==n&&(n={}),this.get((n.authed=!0,n))},get:function(n){return null==n&&(n={authed:!1}),h().then(function(e){return n.authed?(e&&(e.user||(e.user={})).key?Promise.resolve(e):lda.auth.show(n.tab,n.info,n)).then(function(n){return n&&(n.user||(n.user={})).key?(lda.auth.hide("ok"),n):Promise.reject(new ldError(1e3))}):e})},userinfo:function(n){var e;return((e=n)?Promise.resolve(e):this.get().then(function(n){return n.user})).then(function(n){var e,t;return null==n&&(n={}),e=n.plan||{},t=import$({},n),t.plan=e,t.authed=n.key>0,t.isPro=!!/pro/.exec(e.slug||""),t.isBlocked=!!(n.config||(n.config={})).blocked,t})},fetch:function(n){var e,o,i;return null==n&&(n={renew:!0}),e=!1,r.onLater(1e3).then(function(){return e=!0}),o=debounce(1e4,function(){return r.off(),t.get("connection-timeout").then(function(){return r.on(),debounce(1e4)}).then(function(){return g.fetch()})})(),i=!n.renew&&/global=/.exec(document.cookie)?document.cookie.split(";").map(function(n){return/^global=(.+)/.exec(n.trim())}).filter(function(n){return n})[0]:null,(i?Promise.resolve(JSON.parse(decodeURIComponent(i[1]))):ld$.fetch(g.api+"/global",{},{type:"json"})).then(function(n){var i,c,l;o.cancel(),r.cancel(),e&&r.off(),((i=ld$.fetch).headers||(i.headers={}))["X-CSRF-Token"]=n.csrfToken,a.global=n,a.global.location="undefined"!=typeof ipFromTaiwan&&null!==ipFromTaiwan?ipFromTaiwan(n.ip)?"tw":"other":void 0,c=u(),h.resolve(c);try{ldc.fire("auth.change",c),f.check(),"undefined"!=typeof gtag&&null!==gtag&&(!gtag.userid&&c.user&&c.user.key&&(gtag("set",{user_id:gtag.userid=c.user.key}),gtag.inited=!1),gtag.inited||(gtag("config",gtag.code,{anonymize_ip:!0}),gtag.inited=!0))}catch(n){l=n,t.toggle("error"),console.log(l)}return c}).catch(function(n){return o.cancel(),r.cancel(),t.toggle("server-down"),console.log(n),new Promise(function(n,e){}),r.off()})},consentTime:{},consent:function(n){var r,o,i;return null==n&&(n={}),r=n.type||"tos",o=(e.consent||(e.consent={}))[r],i=o?o.cover||"consent":"",Promise.resolve().then(function(){if(o)return g.fetch().then(function(e){var u,c,a,l;if(n.force||!n.timing||in$(n.timing,o.timing))return u=((c=(a=e.user).config||(a.config={})).consent||(c.consent={}))[r]||g.consentTime[r]||0,l=!n.bypass&&(n.force&&Date.now()-u>1e4||!u||u<(o.time||0))?o.prompt?o.prompt():t.getdom(i).then(function(n){var e,r,u;return"link"===o.type?((e=ld$.find(n,"iframe",0)).classList.remove("d-none"),e.setAttribute("src",o.url)):((r=ld$.find(n,"object",0)).classList.remove("d-none"),(u=r)&&u.setAttribute("data",o.url),(u=ld$.find(n,"embed",0))&&u.setAttribute("src",o.url)),t.get(i)}):Promise.resolve(!0),l=l.then(function(n){if(!n)return Promise.reject(new ldError(1018))}),e.user.key&&!((c=(a=e.user).config||(a.config={})).consent||(c.consent={}))[r]?l.then(function(){var n;return g.consentTime[r]=Date.now(),n={type:"consent",name:[r]},ld$.fetch(g.api+"/me/config",{method:"POST"},{json:n,type:"json"}).catch(function(n){return console.log(">",n)})}).then(function(n){var t;return null==n&&(n={}),import$((t=e.user).config||(t.config={}),n)}):l})})},recaptcha:s}).fetch({renew:!0}).then(function(){return s.init()}),p={fb:function(){return g.social("facebook")},google:function(){return g.social("google")},logout:function(){return g.logout()},isOn:function(){return t.isOn("authpanel")},show:function(n,e,r){return null==n&&(n="signup"),null==e&&(e="default"),null==r&&(r={}),Promise.resolve(t.isOn("authpanel")).then(function(e){if(!e)return g.switch(n)}).then(function(){if(e)return p.info(e)}).then(function(){var n;return n=a.form.getFields().email,r.forceEmail?(n.setAttribute("readonly",!0),n.value=r.forceEmail,a.form.check({n:"email",now:!0})):n.removeAttribute("readonly")}).then(function(){return t.get("authpanel")}).then(function(n){if(n)return g.fetch()})},hide:function(n){return null==n&&(n=null),t.set("authpanel",n)},info:function(n){var e,t;return null==n&&(n="default"),e=ld$.find(a.authpanel,"*[data-info]"),t={},e.map(function(n){return t[n.getAttribute("data-info")]=n}),e.map(function(n){return n.classList.add("d-none")}),t[n]||(n="default"),t[n].classList.remove("d-none")}},ldc.action(p),g});