function import$(e,t){var n={}.hasOwnProperty;for(var o in t)n.call(t,o)&&(e[o]=t[o]);return e}var lc,getGlobal,auth,slice$=[].slice;lc={},getGlobal=proxise(function(){if(lc.global)return Promise.resolve(lc.global)}),(auth=function(e){var t,n,o=this;return null==e&&(e={}),this.timeout={loader:1e3,failed:1e4},this.evtHandler={},this.ui={loader:{on:function(){},off:function(){},onLater:function(){},cancel:function(){}},authpanel:function(){return new Promise(function(e,t){})},timeout:function(){return new Promise(function(e,t){})}},function(){var e=[];for(t in this.ui)e.push(t);return e}.call(this).map(function(t){if((e.ui||(e.ui={}))[t])return o.ui[t]=e.ui[t]}),lc.apiRoot||(lc.apiRoot=e.api||"/api/auth","/"!==(n=lc.apiRoot)[n.length-1]&&(lc.apiRoot+="/")),this}).prototype=import$(Object.create(Object.prototype),{on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){var t,n,o,r,i,u=[];for(t=slice$.call(arguments,1),n=0,r=(o=this.evtHandler[e]||[]).length;n<r;++n)i=o[n],u.push(i.apply(this,t));return u},inject:function(){return{}},apiRoot:function(){return lc.apiRoot},logout:function(){var e=this;return this.ui.loader.on(),ld$.fetch(this.apiRoot()+"/logout",{method:"post"},{}).then(function(){return e.fetch({renew:!0})}).then(function(){return e.fire("logout")}).then(function(){return e.ui.loader.off()}).catch(function(){return e.fire("error")})},ensure:function(e){return null==e&&(e={}),this.get((e.authedOnly=!0,e))},get:function(e){var t=this;return null==e&&(e={authedOnly:!1}),getGlobal(e).then(function(n){return null==n&&(n={}),e.authedOnly?((n.user||(n.user={})).key?Promise.resolve(n):t.ui.authpanel(!0,e)).then(function(t){return null==t&&(t={}),e.authedOnly&&!(t.user||(t.user={})).key?Promise.reject(new ldError(1e3)):t}):n})},fetch:function(e){var t,n=this;return null==e&&(e={renew:!0}),this.ui.loader.onLater(this.timeout.loader),this.watchdog=debounce(this.timeout.failed,function(){return n.ui.loader.off(),n.ui.timeout().then(function(){return n.ui.loader.on()}).then(function(){return debounce(1e4)}).then(function(){return n.fetch()})})(),t=!e.renew&&/global=/.exec(document.cookie)?document.cookie.split(";").map(function(e){return/^global=(.+)/.exec(e.trim())}).filter(function(e){return e})[0]:null,(t?Promise.resolve(JSON.parse(decodeURIComponent(t[1]))):ld$.fetch(this.apiRoot()+"info",{},{type:"json"})).finally(function(e){return n.watchdog.cancel(),n.ui.loader.cancel(),n.ui.loader.off()}).then(function(e){var t,o;((t=ld$.fetch).headers||(t.headers={}))["X-CSRF-Token"]=e.csrfToken,e.ext=n.inject(e)||{},getGlobal.resolve(JSON.parse(JSON.stringify(lc.global=e)));try{n.fire("change",lc.global)}catch(e){o=e,n.fire("error",o),console.log(o)}return lc.global}).catch(function(e){return n.fire("server-down",e),console.log(e),new Promise(function(e,t){})})}}),window.auth=auth;