var lc,getGlobal,auth;function import$(e,n){var t,o={}.hasOwnProperty;for(t in n)o.call(n,t)&&(e[t]=n[t]);return e}lc={},getGlobal=proxise(function(){if(lc.global)return Promise.resolve(lc.global)}),(auth=function(n){var t,e,o=this;return null==n&&(n={}),this.timeout={loader:1e3,failed:1e4},this.evtHandler={},this.social={},this.ui={loader:{on:function(){},off:function(){},onLater:function(){},cancel:function(){}},authpanel:function(){return new Promise(function(e,n){})},timeout:function(){return new Promise(function(e,n){})}},function(){var e=[];for(t in this.ui)e.push(t);return e}.call(this).map(function(e){if((n.ui||(n.ui={}))[e])return o.ui[e]=n.ui[e]}),lc.apiRoot||(lc.apiRoot=n.api||"/api/auth","/"!==(e=lc.apiRoot)[e.length-1]&&(lc.apiRoot+="/")),this}).prototype=import$(Object.create(Object.prototype),{on:function(e,n){var t;return((t=this.evtHandler)[e]||(t[e]=[])).push(n)},fire:function(e){for(var n,t,o,r,i=[],u=[],l=1,c=arguments.length;l<c;++l)u.push(arguments[l]);for(n=u,l=0,o=(t=this.evtHandler[e]||[]).length;l<o;++l)r=t[l],i.push(r.apply(this,n));return i},inject:function(){return{}},apiRoot:function(){return lc.apiRoot},logout:function(){var e=this;return this.ui.loader.on(),ld$.fetch(this.apiRoot()+"/logout",{method:"post"},{}).then(function(){return e.fetch({renew:!0})}).then(function(){return e.fire("logout")}).then(function(){return e.ui.loader.off()}).catch(function(){return e.fire("error")})},ensure:function(e){return this.get(((e=null==e?{}:e).authedOnly=!0,e))},get:function(n){var t=this;return getGlobal(n=null==n?{authedOnly:!1}:n).then(function(e){return null==e&&(e={}),n.authedOnly?((e.user||(e.user={})).key?Promise.resolve(e):t.ui.authpanel(!0,n)).then(function(e){return null==e&&(e={}),n.authedOnly&&!(e.user||(e.user={})).key?Promise.reject(new lderror(1e3)):e}):e})},fetch:function(e){var t=this;return null==e&&(e={renew:!0}),this.ui.loader.onLater(this.timeout.loader),this.watchdog=debounce(this.timeout.failed,function(){return t.ui.loader.off(),t.ui.timeout().then(function(){return t.ui.loader.on()}).then(function(){return debounce(1e4)}).then(function(){return t.fetch()})})(),((e=!e.renew&&/global=/.exec(document.cookie)?document.cookie.split(";").map(function(e){return/^global=(.+)/.exec(e.trim())}).filter(function(e){return e})[0]:null)?Promise.resolve(JSON.parse(decodeURIComponent(e[1]))):ld$.fetch(this.apiRoot()+"info",{},{type:"json"})).finally(function(e){return t.watchdog.cancel(),t.ui.loader.cancel(),t.ui.loader.off()}).then(function(n){var e;((e=ld$.fetch).headers||(e.headers={}))["X-CSRF-Token"]=n.csrfToken,n.ext=t.inject(n)||{},getGlobal.resolve(JSON.parse(JSON.stringify(lc.global=n)));try{t.fire("change",lc.global)}catch(e){t.fire("error",n=e),console.log(n)}return lc.global}).catch(function(e){return t.fire("server-down",e),console.log(e),new Promise(function(e,n){})})},local:function(e){return this.ui.authpanel(!0,e)},authpanel:function(e){},social:function(n){var t=this,o=n.name,r=null;return this.get().then(function(e){var n;return((e=null==e?{}:e).user||(e.user={})).key?e:(t.social.window=window.open("","social-login","height=640,width=560"),t.social.form=n=ld$.create({name:"div"}),n.innerHTML='<form target="social-login" action="'+t.apiRoot()+"auth/"+o+'/" method="post">\n  <input type="hidden" name="_csrf" value="'+e.csrfToken+'"/>\n</form>',document.body.appendChild(n),window.socialLogin=n=proxise(function(){return ld$.find(r,"form",0).submit()}),n())}).then(function(e){if(!((e=null==e?{}:e).user||(e.user={})).key)return Promise.reject(new lderror(1e3))}).finally(function(){return t.social.form.parentNode.removeChild(t.social.form)}).then(function(){}).then(function(){return t.fire("change")}).catch(function(){return this.fire("error",e),Promise.reject(e)})}});