function import$(e,n){var t={}.hasOwnProperty;for(var o in n)t.call(n,o)&&(e[o]=n[o]);return e}var lc,getGlobal,auth,slice$=[].slice;lc={},getGlobal=proxise(function(){if(lc.global)return Promise.resolve(lc.global)}),(auth=function(e){var n,t,o=this;return null==e&&(e={}),this.timeout={loader:1e3,failed:1e4},this.evtHandler={},this.social={},this.ui={loader:{on:function(){},off:function(){},onLater:function(){},cancel:function(){}},authpanel:function(){return new Promise(function(e,n){})},timeout:function(){return new Promise(function(e,n){})}},function(){var e=[];for(n in this.ui)e.push(n);return e}.call(this).map(function(n){if((e.ui||(e.ui={}))[n])return o.ui[n]=e.ui[n]}),lc.apiRoot||(lc.apiRoot=e.api||"/api/auth","/"!==(t=lc.apiRoot)[t.length-1]&&(lc.apiRoot+="/")),this}).prototype=import$(Object.create(Object.prototype),{on:function(e,n){var t;return((t=this.evtHandler)[e]||(t[e]=[])).push(n)},fire:function(e){var n,t,o,r,i,u=[];for(n=slice$.call(arguments,1),t=0,r=(o=this.evtHandler[e]||[]).length;t<r;++t)i=o[t],u.push(i.apply(this,n));return u},inject:function(){return{}},apiRoot:function(){return lc.apiRoot},logout:function(){var e=this;return this.ui.loader.on(),ld$.fetch(this.apiRoot()+"/logout",{method:"post"},{}).then(function(){return e.fetch({renew:!0})}).then(function(){return e.fire("logout")}).then(function(){return e.ui.loader.off()}).catch(function(){return e.fire("error")})},ensure:function(e){return null==e&&(e={}),this.get((e.authedOnly=!0,e))},get:function(e){var n=this;return null==e&&(e={authedOnly:!1}),getGlobal(e).then(function(t){return null==t&&(t={}),e.authedOnly?((t.user||(t.user={})).key?Promise.resolve(t):n.ui.authpanel(!0,e)).then(function(n){return null==n&&(n={}),e.authedOnly&&!(n.user||(n.user={})).key?Promise.reject(new ldError(1e3)):n}):t})},fetch:function(e){var n,t=this;return null==e&&(e={renew:!0}),this.ui.loader.onLater(this.timeout.loader),this.watchdog=debounce(this.timeout.failed,function(){return t.ui.loader.off(),t.ui.timeout().then(function(){return t.ui.loader.on()}).then(function(){return debounce(1e4)}).then(function(){return t.fetch()})})(),n=!e.renew&&/global=/.exec(document.cookie)?document.cookie.split(";").map(function(e){return/^global=(.+)/.exec(e.trim())}).filter(function(e){return e})[0]:null,(n?Promise.resolve(JSON.parse(decodeURIComponent(n[1]))):ld$.fetch(this.apiRoot()+"info",{},{type:"json"})).finally(function(e){return t.watchdog.cancel(),t.ui.loader.cancel(),t.ui.loader.off()}).then(function(e){var n,o;((n=ld$.fetch).headers||(n.headers={}))["X-CSRF-Token"]=e.csrfToken,e.ext=t.inject(e)||{},getGlobal.resolve(JSON.parse(JSON.stringify(lc.global=e)));try{t.fire("change",lc.global)}catch(e){o=e,t.fire("error",o),console.log(o)}return lc.global}).catch(function(e){return t.fire("server-down",e),console.log(e),new Promise(function(e,n){})})},local:function(e){return this.ui.authpanel(!0,e)},authpanel:function(e){},social:function(n){var t,o=this;return t=n.name,null,this.get().then(function(e){var n,r;return null==e&&(e={}),(e.user||(e.user={})).key?e:(o.social.window=window.open("","social-login","height=640,width=560"),o.social.form=n=ld$.create({name:"div"}),n.innerHTML='<form target="social-login" action="'+o.apiRoot()+"auth/"+t+'/" method="post">\n  <input type="hidden" name="_csrf" value="'+e.csrfToken+'"/>\n</form>',document.body.appendChild(n),window.socialLogin=r=proxise(function(){return ld$.find(null,"form",0).submit()}),r())}).then(function(e){if(null==e&&(e={}),!(e.user||(e.user={})).key)return Promise.reject(new ldError(1e3))}).finally(function(){return o.social.form.parentNode.removeChild(o.social.form)}).then(function(){}).then(function(){return o.fire("change")}).catch(function(){return this.fire("error",e),Promise.reject(e)})}});